#!/usr/bin/env bash
set -e

PORT=3001

echo "ðŸ§ª Preparing test database..."
RAILS_ENV=test bin/rails db:test:prepare

echo "ðŸ”§ Starting Rails server on port $PORT in test environment..."
RAILS_ENV=test bin/rails server -p $PORT &
RAILS_PID=$!

echo "â³ Waiting for Rails server to respond..."
for i in {1..20}; do
  if curl -s http://localhost:$PORT > /dev/null; then
    echo "âœ… Rails server is up on port $PORT!"
    break
  fi
  sleep 0.5
done

if ! kill -0 "$RAILS_PID" 2>/dev/null; then
  echo "âŒ Rails server failed to start. See /tmp/rails-test.log for details."
  exit 1
fi

echo "ðŸŽ­ Running Playwright..."

npx playwright test --config=e2e/playwright.config.js "$@"

echo "ðŸ§¹ Stopping Rails server"
kill "$RAILS_PID"
wait "$RAILS_PID" 2>/dev/null || true

echo "âœ… Done."
